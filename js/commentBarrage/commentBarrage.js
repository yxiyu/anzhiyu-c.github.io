let commentBarrageConfig={lightColors:[["#ffffffaa","var(--anzhiyu-black)"]],darkColors:[["#000a","var(--anzhiyu-white)"]],maxBarrage:1,barrageTime:3e3,twikooUrl:"https://twikoo.anzhiy.cn",accessToken:"54f68b0df8c313122ba83569cade88ab",pageUrl:window.location.pathname,barragecommentBarrageTimer:[],barrageList:[],barrageIndex:0,noAvatarType:"retro",dom:document.querySelector(".comment-barrage"),displayBarrage:!0,avatarCDN:"cravatar.cn"};function isDOMContains(e,r,a){if(e===r)return!0;if(!r||!r.nodeType||1!==r.nodeType)return!1;if(e&&e.contains)return e.contains(r);if(e&&e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(r));let n=r.parentNode;for(;n&&n!==a;){if(n===e)return!0;n=n.parentNode}return!1}function isInViewPortOfOne(e){if(!e)return;const r=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;return e.offsetTop-document.documentElement.scrollTop<=r}var commentBarrageTimer;function initCommentBarrage(){commentBarrageTimer&&clearInterval(commentBarrageTimer);var e=JSON.stringify({event:"COMMENT_GET","commentBarrageConfig.accessToken":commentBarrageConfig.accessToken,url:commentBarrageConfig.pageUrl}),r=new XMLHttpRequest;r.withCredentials=!0,r.addEventListener("readystatechange",(function(){4===this.readyState&&(commentBarrageConfig.barrageList=commentLinkFilter(JSON.parse(this.responseText).data),commentBarrageConfig.dom&&(commentBarrageConfig.dom.innerHTML=""))})),r.open("POST",commentBarrageConfig.twikooUrl),r.setRequestHeader("Content-Type","application/json"),r.send(e),commentBarrageTimer=setInterval((()=>{commentBarrageConfig.barrageList.length&&(popCommentBarrage(commentBarrageConfig.barrageList[commentBarrageConfig.barrageIndex]),commentBarrageConfig.barrageIndex+=1,commentBarrageConfig.barrageIndex%=commentBarrageConfig.barrageList.length),commentBarrageConfig.barragecommentBarrageTimer.length>(commentBarrageConfig.barrageList.length>commentBarrageConfig.maxBarrage?commentBarrageConfig.maxBarrage:commentBarrageConfig.barrageList.length)&&removeCommentBarrage(commentBarrageConfig.barragecommentBarrageTimer.shift())}),commentBarrageConfig.barrageTime)}function commentLinkFilter(e){e.sort(((e,r)=>e.created-r.created));let r=[];return e.forEach((e=>{r.push(...getCommentReplies(e))})),r}function getCommentReplies(e){if(e.replies){let r=[e];return e.replies.forEach((e=>{r.push(...getCommentReplies(e))})),r}return[]}function popCommentBarrage(e){let r=document.createElement("div");r.className="comment-barrage-item";let a=Math.floor(Math.random()*commentBarrageConfig.lightColors.length);document.getElementById("barragesColor").innerHTML=`[data-theme='light'] .comment-barrage-item { background-color:${commentBarrageConfig.lightColors[a][0]};color:${commentBarrageConfig.lightColors[a][1]}}[data-theme='dark'] .comment-barrage-item{ background-color:${commentBarrageConfig.darkColors[a][0]};color:${commentBarrageConfig.darkColors[a][1]}}`,r.innerHTML=`\n\t<div class="barrageHead">\n\t\t<img class="barrageAvatar" src="https://${commentBarrageConfig.avatarCDN}/avatar/${e.mailMd5}?d=${commentBarrageConfig.noAvatarType}"/>\n\t\t<div class="barrageNick">${e.nick}</div>\n\t\t<a href="javascript:switchCommentBarrage()" style="font-size:20px">×</a>\n\t</div>\n\t<div class="barrageContent">${e.comment}</div>\n\t`,commentBarrageConfig.barragecommentBarrageTimer.push(r),commentBarrageConfig.dom.append(r)}function removeCommentBarrage(e){e.className="comment-barrage-item out",isDOMContains(commentBarrageConfig.dom,e,document.querySelector("#post-comment"))&&(1!=commentBarrageConfig.maxBarrage?setTimeout((()=>{commentBarrageConfig.dom.removeChild(e)}),1e3):commentBarrageConfig.dom.removeChild(e))}document.onscroll=function(){if(commentBarrageConfig.displayBarrage){if(!document.getElementsByClassName("comment-barrage")[0])return;isInViewPortOfOne(document.getElementById("post-comment"))?document.getElementsByClassName("comment-barrage")[0].setAttribute("style","display:none;"):document.getElementsByClassName("comment-barrage")[0].setAttribute("style","")}};let switchCommentBarrageFlag=!0;document.addEventListener("pjax:success",(e=>{commentBarrageConfig.dom=document.querySelector(".comment-barrage"),commentBarrageConfig.pageUrl=window.location.pathname,initCommentBarrage(),$(".comment-barrage").hover((function(){clearInterval(commentBarrageTimer)}),(function(){commentBarrageTimer=setInterval((()=>{commentBarrageConfig.barrageList.length&&(popCommentBarrage(commentBarrageConfig.barrageList[commentBarrageConfig.barrageIndex]),commentBarrageConfig.barrageIndex+=1,commentBarrageConfig.barrageIndex%=commentBarrageConfig.barrageList.length),commentBarrageConfig.barragecommentBarrageTimer.length>(commentBarrageConfig.barrageList.length>commentBarrageConfig.maxBarrage?commentBarrageConfig.maxBarrage:commentBarrageConfig.barrageList.length)&&removeCommentBarrage(commentBarrageConfig.barragecommentBarrageTimer.shift())}),commentBarrageConfig.barrageTime)}))})),switchCommentBarrage=function(){if(!isInViewPortOfOne(document.getElementById("post-comment"))){commentBarrageConfig.displayBarrage=!commentBarrageConfig.displayBarrage;let e=document.querySelector(".comment-barrage");e&&$(e).fadeToggle((()=>{btf.snackbarShow(`✨ 已${switchCommentBarrageFlag?"关闭":"开启"}评论弹幕`),switchCommentBarrageFlag=!switchCommentBarrageFlag}))}},$(".comment-barrage").hover((function(){clearInterval(commentBarrageTimer)}),(function(){commentBarrageTimer=setInterval((()=>{commentBarrageConfig.barrageList.length&&(popCommentBarrage(commentBarrageConfig.barrageList[commentBarrageConfig.barrageIndex]),commentBarrageConfig.barrageIndex+=1,commentBarrageConfig.barrageIndex%=commentBarrageConfig.barrageList.length),commentBarrageConfig.barragecommentBarrageTimer.length>(commentBarrageConfig.barrageList.length>commentBarrageConfig.maxBarrage?commentBarrageConfig.maxBarrage:commentBarrageConfig.barrageList.length)&&removeCommentBarrage(commentBarrageConfig.barragecommentBarrageTimer.shift())}),commentBarrageConfig.barrageTime)})),initCommentBarrage();